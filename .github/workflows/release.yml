name: Release

on:
  push:
    branches: [main]

jobs:

  release:
    name: Container Image & Chart 
    runs-on: ubuntu-latest
    steps:
    -
      uses: actions/checkout@v2
    - 
      uses: go-semantic-release/action@v1.11.2
      id: version
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        allow-initial-development-versions: true
    -
      name: Check for changes
      uses: andymckay/cancel-action@0.2
      if: ${{ steps.version.outputs.version == '' }}
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
     -
      name: Set up QEMU
      uses: docker/setup-qemu-action@v1.1.0
     -
      name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v1.3.0
     -
      name: Docker login
      if: ${{ steps.version.outputs.version != '' }}
      uses: docker/login-action@v1.9.0
      with:
        username: deyaeddin
        password: ${{ secrets.DOCKER_TOKEN }}
     -
      name: Build release
      if: ${{ steps.version.outputs.version != '' }}
      run: make build IMAGE_TAG="${{ steps.version.outputs.version }}"
     -
      name: Push image release
      if: ${{ steps.version.outputs.version != '' }}
      run: make push-release IMAGE_TAG="${{ steps.version.outputs.version }}"
     -
      name: Build Edge
      run: make build-edge
     -
      name: Push Edge
      run: make push-release
     -
      name: Rollback Release
      if: ${{ failure() && steps.version.outputs.version != '' }}
      uses: author/action-rollback@stable
      with:
        tag: ${{ steps.version.outputs.version }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}